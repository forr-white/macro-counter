<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 15px; background-color: #f5f5f5; }
    
    /* NEW LOGO HEADER STYLES */
    .logo-container { text-align: center; margin-bottom: 20px; }
    .logo-img { 
        max-width: 150px; /* Limits size so it looks good on phone */
        height: auto; 
        border-radius: 8px; /* Optional: Slight curve on corners */
    }

    /* HEADER STYLES */
    .header-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    h3 { color: #333; margin: 0; }

    /* TABLES */
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;}
    th { background-color: #2c3e50; color: white; padding: 10px; font-size: 0.75em; text-transform: uppercase; text-align: center;}
    td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; color: #333; font-size: 0.9em;}
    .text-left { text-align: left; }

    /* CONDITIONAL FORMATTING COLORS */
    .stat-green { background-color: #c8e6c9; color: #2e7d32; font-weight: bold; }
    .stat-yellow { background-color: #fff9c4; color: #f9a825; font-weight: bold; }
    .stat-red { background-color: #ffcdd2; color: #c62828; font-weight: bold; }

    /* INPUTS */
    input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 16px; }
    .qty-input { width: 60px; text-align: center; font-weight: bold; }
    
    /* BUTTONS */
    .btn { cursor: pointer; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold; color: white; }
    .btn-add { background-color: #3498db; }
    .btn-copy { background-color: #9b59b6; }
    .btn-save { background-color: #27ae60; width: 100%; margin-top: 15px; font-size: 1.1em; padding: 12px; }
    .btn-del { background-color: #e74c3c; padding: 6px 10px; font-size: 12px; }
    .btn-refresh { background-color: #607d8b; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }

    /* TOTALS & LOG GRID */
    .totals-row td { font-weight: bold; background-color: #ecf0f1; border-top: 2px solid #bdc3c7; }
    .log-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .log-grid div label { display: block; font-size: 0.7em; color: #777; margin-bottom: 2px; }
  </style>
</head>
<body>

  <div class="logo-container">
    <a href="https://forr-white.github.io/macro-counter/">
        <img src="photo.png" alt="App Logo" class="logo-img">
    </a>
  </div>

  <div class="header-container">
    <h3>Meal Calculator</h3>
    <button class="btn btn-refresh" onclick="refreshData()">
      <span>↻</span> Sync
    </button>
  </div>

  <table id="calcTable">
    <thead>
      <tr>
        <th class="text-left">Food</th>
        <th>Qty</th>
        <th>Cal</th>
        <th>Pro</th>
        <th>Carb</th>
        <th>Fat</th>
        <th>Fib</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="calcBody"></tbody>
    <tfoot>
      <tr class="totals-row">
        <td class="text-left">TOTAL:</td>
        <td>-</td>
        <td id="t-cal">0</td>
        <td id="t-pro">0</td>
        <td id="t-carb">0</td>
        <td id="t-fat">0</td>
        <td id="t-fib">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
  
  <div style="display: flex; gap: 10px;">
    <button class="btn btn-add" onclick="addRow()">+ Add Item</button>
    <button class="btn btn-copy" onclick="copyToLog()">⬇ Move to Log</button>
  </div>

  <div class="header-container" style="margin-top: 30px;">
    <h3>Log Daily Entry</h3>
  </div>

  <form id="macroForm">
    <div style="margin-bottom: 10px; display: flex; gap: 10px;">
        <div style="flex: 1;">
            <label style="font-size: 0.8em; color: #666;">User</label>
            <select id="userSelect" name="user" onchange="loadHistory()">
                <option value="Forrest">Forrest</option>
                <option value="Christine">Christine</option>
            </select>
        </div>
        <div style="width: 100px;">
            <label style="font-size: 0.8em; color: #666;">Weight</label>
            <input type="number" name="weight" placeholder="lbs" step="0.1">
        </div>
    </div>

    <div class="log-grid">
        <div><label>Calories</label><input type="number" id="in-cal" name="calories"></div>
        <div><label>Protein</label><input type="number" id="in-pro" name="protein"></div>
        <div><label>Carbs</label><input type="number" id="in-carb" name="carbs"></div>
        <div><label>Fat</label><input type="number" id="in-fat" name="fat"></div>
        <div><label>Fiber</label><input type="number" id="in-fib" name="fiber"></div>
    </div>

    <button type="submit" class="btn btn-save">Save to Log</button>
  </form>
  <p id="status" style="text-align: center; margin-top: 10px; font-weight: bold; min-height: 20px;"></p>

  <div class="header-container" style="margin-top: 30px;">
    <h3>History</h3>
  </div>
  
  <table id="historyTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Wt</th>
        <th>Cal</th>
        <th>Pro</th>
        <th>Carb</th>
        <th>Fat</th>
        <th>Fib</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>

  <script>
    // --- SETTINGS ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxK1ydSSXucxpYTy53-lPnJDDT6d8QrsPo9SfiexgMVO3uPp9oSnkV3wiHM7w-CHf6F4g/exec'; 

    let foodDatabase = [];

    window.onload = function() {
        loadFoodData();
        loadHistory();
    };

    function refreshData() {
        const btn = document.querySelector('.btn-refresh');
        const originalText = btn.innerHTML;
        btn.innerHTML = "Loading...";
        btn.style.opacity = "0.7";
        loadHistory().then(() => {
            btn.innerHTML = originalText;
            btn.style.opacity = "1";
        });
        loadFoodData(); 
    }

    // --- 1. DATA LOADING ---
    function loadFoodData() {
        fetch(scriptURL)
        .then(res => res.json())
        .then(data => {
            foodDatabase = data;
            foodDatabase.sort((a, b) => (a.category > b.category) ? 1 : -1);
            
            const tbody = document.getElementById('calcBody');
            if(tbody.children.length === 0) {
                addRow(); 
            }
        });
    }

    function loadHistory() {
        const user = document.getElementById('userSelect').value;
        const historyBody = document.getElementById('historyBody');

        historyBody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

        return fetch(`${scriptURL}?action=getHistory&user=${user}`)
        .then(res => res.json())
        .then(data => {
            historyBody.innerHTML = ""; 
            if (data.length === 0) { historyBody.innerHTML = '<tr><td colspan="7">No logs.</td></tr>'; return; }

            data.forEach(row => {
                let dateStr = ""; 
                if (row[0]) {
                    const d = new Date(row[0]);
                    if (!isNaN(d.getTime())) {
                        dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                }
                if (dateStr === "") return; 

                const cal = parseFloat(row[2]) || 0;
                const pro = parseFloat(row[3]) || 0;
                const carb = parseFloat(row[4]) || 0;
                const fat = parseFloat(row[5]) || 0;
                const fib = parseFloat(row[6]) || 0;

                let colorFunc = (user === "Forrest") ? getForrestColor : getChristineColor;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${row[1]||"-"}</td>
                    <td class="${colorFunc('calories', cal)}">${cal}</td>
                    <td class="${colorFunc('protein', pro)}">${pro}</td>
                    <td class="${colorFunc('carbs', carb)}">${carb}</td>
                    <td class="${colorFunc('fat', fat)}">${fat}</td>
                    <td class="${colorFunc('fiber', fib)}">${fib}</td>
                `;
                historyBody.appendChild(tr);
            });
            document.getElementById('historyTable').scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
    }

    // --- 2. CUSTOM LOGIC FOR FORREST ---
    function getForrestColor(metric, val) {
        if (val === 0) return ""; 
        
        if (metric === 'calories') return (val <= 2400) ? 'stat-green' : 'stat-red';
        if (metric === 'protein') return (val >= 225) ? 'stat-green' : 'stat-red';
        if (metric === 'carbs') return (val <= 160) ? 'stat-green' : 'stat-red';
        if (metric === 'fat') return (val <= 85) ? 'stat-green' : 'stat-red';
        if (metric === 'fiber') {
            if (val < 30) return 'stat-red';
            if (val <= 40) return 'stat-green';
            if (val <= 50) return 'stat-yellow';
            return 'stat-red';
        }
        return ""; 
    }

    // --- 3. CUSTOM LOGIC FOR CHRISTINE ---
    function getChristineColor(metric, val) {
        if (val === 0) return ""; 
        if (metric === 'calories' && val > 1800) return 'stat-red';
        return 'stat-green';
    }

    // --- 4. CALCULATOR & OTHER FUNCTIONS ---
    function addRow() {
        const tbody = document.getElementById('calcBody');
        const tr = document.createElement('tr');
        
        let options = `<option value="">Select Food...</option>`;
        let currentCat = "";
        
        foodDatabase.forEach((food, index) => {
            if (food.category !== currentCat) {
                if (currentCat !== "") options += `</optgroup>`;
                currentCat = food.category;
                options += `<optgroup label="${currentCat}">`;
            }
            options += `<option value="${index}">${food.name}</option>`;
        });
        if (currentCat !== "") options += `</optgroup>`;

        tr.innerHTML = `
            <td class="text-left"><select onchange="calcRow(this)">${options}</select></td>
            <td><input type="number" class="qty-input" placeholder="1" value="1" oninput="calcRow(this)"></td>
            <td class="r-cal">0</td><td class="r-pro">0</td><td class="r-carb">0</td><td class="r-fat">0</td><td class="r-fib">0</td>
            <td><button class="btn btn-del" onclick="removeRow(this)">x</button></td>
        `;
        tbody.appendChild(tr);
    }

    function removeRow(btn) { btn.closest('tr').remove(); calcTotals(); }

    function calcRow(el) {
        const tr = el.closest('tr');
        const index = tr.querySelector('select').value;
        const qty = parseFloat(tr.querySelector('input').value) || 0;

        if (index !== "") {
            const food = foodDatabase[index];
            tr.querySelector('.r-cal').innerText = Math.round(food.cal * qty);
            tr.querySelector('.r-pro').innerText = Math.round(food.pro * qty);
            tr.querySelector('.r-carb').innerText = Math.round(food.carb * qty);
            tr.querySelector('.r-fat').innerText = Math.round(food.fat * qty);
            tr.querySelector('.r-fib').innerText = Math.round(food.fiber * qty);
        }
        calcTotals();
    }

    function calcTotals() {
        let tCal=0, tPro=0, tCarb=0, tFat=0, tFib=0;
        document.querySelectorAll('#calcBody tr').forEach(tr => {
            tCal += parseFloat(tr.querySelector('.r-cal').innerText) || 0;
            tPro += parseFloat(tr.querySelector('.r-pro').innerText) || 0;
            tCarb += parseFloat(tr.querySelector('.r-carb').innerText) || 0;
            tFat += parseFloat(tr.querySelector('.r-fat').innerText) || 0;
            tFib += parseFloat(tr.querySelector('.r-fib').innerText) || 0;
        });
        document.getElementById('t-cal').innerText = tCal;
        document.getElementById('t-pro').innerText = tPro;
        document.getElementById('t-carb').innerText = tCarb;
        document.getElementById('t-fat').innerText = tFat;
        document.getElementById('t-fib').innerText = tFib;
    }

    function copyToLog() {
        document.getElementById('in-cal').value = document.getElementById('t-cal').innerText;
        document.getElementById('in-pro').value = document.getElementById('t-pro').innerText;
        document.getElementById('in-carb').value = document.getElementById('t-carb').innerText;
        document.getElementById('in-fat').value = document.getElementById('t-fat').innerText;
        document.getElementById('in-fib').value = document.getElementById('t-fib').innerText;
    }

    document.getElementById('macroForm').addEventListener('submit', e => {
      e.preventDefault();
      const status = document.getElementById('status');
      status.innerText = "Saving...";
      
      fetch(scriptURL, { method: 'POST', body: new FormData(e.target)})
        .then(() => {
            status.innerText = "✅ Saved!";
            e.target.reset();
            setTimeout(loadHistory, 1000);
        })
        .catch(() => status.innerText = "❌ Error.");
    });
  </script>
</body>
</html>
